<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حلقة الفتح - متابعة الطلاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#059669', // emerald-600
                        secondary: '#e2e8f0',
                        background: '#ffffff',
                        foreground: '#0f172a',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-slate-900">
<div id="app" class="min-h-screen flex flex-col">
    <!-- Content will be injected here by JavaScript -->
</div>

<script>
    // --- Data & State ---
    const HIJRI_MONTHS = [
        "محرم", "صفر", "ربيع الأول", "ربيع الثاني", "جمادى الأولى", "جمادى الآخرة",
        "رجب", "شعبان", "رمضان", "شوال", "ذو القعدة", "ذو الحجة"
    ];

    let state = {
        students: [],
        viewMode: 'student', // 'student' or 'daily'
        selectedStudentId: null,
        selectedDay: new Date().getDate(), // 1-30
        filterTeacher: 'all',
        isOnline: navigator.onLine,
        lastSaved: null
    };

    // --- Hijri Calendar Logic ---
    function getHijriDate(date = new Date()) {
        const gYear = date.getFullYear();
        const gMonth = date.getMonth();
        const gDay = date.getDate();

        // Simplified Hijri calculation
        const startOfHijriYear = new Date(gYear, 0, 1); // Approximation
        const daysSinceStart = Math.floor((date.getTime() - startOfHijriYear.getTime()) / (1000 * 60 * 60 * 24));

        // This is a rough approximation for demo purposes
        // In a real app, use a library like moment-hijri
        const hYear = Math.floor((gYear - 622) * (33/32));
        const hMonth = 2; // Fixed to Rabi Al-Awwal as per request context
        const hDay = Math.min(30, Math.max(1, gDay)); // Just mapping gregorian day for simplicity in this demo

        return { day: hDay, month: hMonth, year: 1447, monthName: HIJRI_MONTHS[hMonth] };
    }

    // --- Data Management ---
    function initData() {
        const saved = localStorage.getItem('halaqah-data-vanilla');
        if (saved) {
            state.students = JSON.parse(saved);
        } else {
            state.students = getInitialStudents();
            saveData();
        }
        render();
    }

    function saveData() {
        localStorage.setItem('halaqah-data-vanilla', JSON.stringify(state.students));
        state.lastSaved = new Date();
        updateOfflineIndicator();
    }

    function getInitialStudents() {
        const names = [
            { name: "إسلام رشاد الصلاحي", surah: "فصلت", age: 15, teacher: "خليل" },
            { name: "إسلام عباس حميد", surah: "الأنعام", age: 15, teacher: "خليل" },
            { name: "سلمان فضل الخياط", surah: "طه", age: 14, teacher: "خليل" },
            { name: "عبدالرحمن عدنان الشميري", surah: "الزمر", age: 14, teacher: "محمد" },
            { name: "مالك عبدالقوي الصلوي", surah: "الروم", age: 12, teacher: "محمد" },
            { name: "أحمد محمود الحداد", surah: "النور", age: 13, teacher: "محمد" },
            { name: "يوسف علي المنصور", surah: "الكهف", age: 14, teacher: "محمد" },
            { name: "عمر خالد السعدي", surah: "مريم", age: 13, teacher: "محمد" }
        ];

        return names.map((s, i) => ({
            id: String(i + 1),
            ...s,
            attendance: 0, // Calculated field
            dailyScores: Array(30).fill(null).map(() => ({ memorization: 0, review: 0, attended: false }))
        }));
    }

    // --- Logic Helpers ---
    function calculateStats(students) {
        let totalMem = 0;
        let totalRev = 0;
        let totalAtt = 0;

        students.forEach(s => {
            // Recalculate attendance based on daily scores
            const daysPresent = s.dailyScores.filter(d => d.memorization > 0 || d.review > 0 || d.attended).length;
            s.attendance = daysPresent; // Update local model

            totalAtt += daysPresent;
            totalMem += s.dailyScores.reduce((sum, d) => sum + (d.memorization || 0), 0);
            totalRev += s.dailyScores.reduce((sum, d) => sum + (d.review || 0), 0);
        });

        return { totalMem, totalRev, totalAtt };
    }

    function updateScore(studentId, dayIndex, type, value) {
        const student = state.students.find(s => s.id === studentId);
        if (!student) return;

        const day = student.dailyScores[dayIndex];

        if (type === 'memorization') day.memorization = parseFloat(value) || 0;
        if (type === 'review') day.review = parseFloat(value) || 0;

        // Auto-handle attendance
        if (day.memorization > 0 || day.review > 0) {
            day.attended = true;
        }

        saveData();
        render(); // Re-render to update stats and UI states
    }

    function toggleAttendance(studentId, dayIndex) {
        const student = state.students.find(s => s.id === studentId);
        if (!student) return;

        const day = student.dailyScores[dayIndex];

        // Only allow toggling if no scores are entered
        if (day.memorization === 0 && day.review === 0) {
            day.attended = !day.attended;
            saveData();
            render();
        }
    }

    // --- Rendering ---
    function render() {
        const app = document.getElementById('app');
        const hijri = getHijriDate();
        const filteredStudents = state.filterTeacher === 'all'
            ? state.students
            : state.students.filter(s => s.teacher === state.filterTeacher);

        const stats = calculateStats(filteredStudents);

        // Header
        let html = `
                <div class="bg-white border-b sticky top-0 z-20 shadow-sm">
                    <div class="container max-w-2xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 rounded-2xl bg-emerald-50 flex items-center justify-center">
                                    <i data-lucide="book-open" class="w-6 h-6 text-emerald-600"></i>
                                </div>
                                <div>
                                    <h1 class="text-xl font-bold text-slate-900">حلقة الفتح</h1>
                                    <div class="flex items-center gap-2 text-sm text-slate-500">
                                        <span>${hijri.day} ${hijri.monthName} ${hijri.year}</span>
                                        <button onclick="goToToday()" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-0.5 rounded-full transition-colors">
                                            اليوم
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="offline-indicator" class="w-3 h-3 rounded-full ${state.isOnline ? 'bg-emerald-500' : 'bg-amber-500'}"></div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-3 gap-2 mb-4">
                            <div class="bg-slate-50 p-3 rounded-xl text-center border border-slate-100">
                                <i data-lucide="users" class="w-4 h-4 mx-auto mb-1 text-slate-400"></i>
                                <div class="text-2xl font-bold text-slate-700">${filteredStudents.length}</div>
                                <div class="text-xs text-slate-500">طلاب</div>
                            </div>
                            <div class="bg-emerald-50 p-3 rounded-xl text-center border border-emerald-100">
                                <i data-lucide="book-open" class="w-4 h-4 mx-auto mb-1 text-emerald-600"></i>
                                <div class="text-2xl font-bold text-emerald-700">${stats.totalMem.toFixed(0)}</div>
                                <div class="text-xs text-emerald-600">حفظ</div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-xl text-center border border-blue-100">
                                <i data-lucide="book-open" class="w-4 h-4 mx-auto mb-1 text-blue-600"></i>
                                <div class="text-2xl font-bold text-blue-700">${stats.totalRev.toFixed(0)}</div>
                                <div class="text-xs text-blue-600">مراجعة</div>
                            </div>
                        </div>

                        <!-- Navigation & Filters -->
                        <div class="flex gap-2 mb-3">
                            <button onclick="setViewMode('student')" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${state.viewMode === 'student' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-700'}">
                                <i data-lucide="user-circle" class="w-4 h-4"></i>
                                عرض الطلاب
                            </button>
                            <button onclick="setViewMode('daily')" class="flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${state.viewMode === 'daily' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-700'}">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                الإدخال اليومي
                            </button>
                        </div>

                        <div class="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4 no-scrollbar">
                            <button onclick="setFilter('all')" class="whitespace-nowrap px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${state.filterTeacher === 'all' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                                الكل
                            </button>
                            <button onclick="setFilter('خليل')" class="whitespace-nowrap px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${state.filterTeacher === 'خليل' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                                أستاذ خليل
                            </button>
                            <button onclick="setFilter('محمد')" class="whitespace-nowrap px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${state.filterTeacher === 'محمد' ? 'bg-slate-900 text-white' : 'bg-white border border-slate-200 text-slate-600'}">
                                أستاذ محمد
                            </button>
                        </div>
                    </div>
                </div>
            `;

        // Main Content
        html += `<div class="container max-w-2xl mx-auto px-4 py-6 flex-1">`;

        if (state.viewMode === 'student') {
            if (state.selectedStudentId) {
                html += renderStudentDetail(state.selectedStudentId);
            } else {
                html += renderStudentList(filteredStudents);
            }
        } else {
            html += renderDailyView(filteredStudents);
        }

        html += `</div>`;
        app.innerHTML = html;
        lucide.createIcons();
    }

    function renderStudentList(students) {
        return `
                <div class="space-y-3 animate-fade-in">
                    ${students.map(student => {
            const totalMem = student.dailyScores.reduce((sum, d) => sum + (d.memorization || 0), 0);
            const totalRev = student.dailyScores.reduce((sum, d) => sum + (d.review || 0), 0);
            const attendanceRate = Math.round((student.attendance / 30) * 100);

            return `
                        <div onclick="selectStudent('${student.id}')" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer active:scale-[0.99]">
                            <div class="flex items-start justify-between gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h3 class="text-lg font-bold text-slate-900 truncate">${student.name}</h3>
                                        <span class="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full">${student.age} سنة</span>
                                    </div>
                                    <p class="text-sm text-slate-500 mb-3">${student.surah}</p>

                                    <div class="flex items-center gap-4 text-sm">
                                        <div class="flex items-center gap-1">
                                            <span class="text-slate-500">حضور:</span>
                                            <span class="font-bold text-slate-900">${student.attendance}</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-emerald-600 font-bold">${totalMem.toFixed(1)}</span>
                                            <span class="text-slate-400 text-xs">حفظ</span>
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <span class="text-blue-600 font-bold">${totalRev.toFixed(1)}</span>
                                            <span class="text-slate-400 text-xs">مراجعة</span>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-2 mt-3">
                                        <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-emerald-500 rounded-full" style="width: ${attendanceRate}%"></div>
                                        </div>
                                        <span class="text-xs font-medium text-slate-400 w-8 text-left">${attendanceRate}%</span>
                                    </div>
                                </div>
                                <i data-lucide="chevron-left" class="w-5 h-5 text-slate-300 mt-1"></i>
                            </div>
                        </div>
                        `;
        }).join('')}
                </div>
            `;
    }

    function renderStudentDetail(studentId) {
        const student = state.students.find(s => s.id === studentId);
        if (!student) return '';

        return `
                <div class="animate-fade-in">
                    <button onclick="selectStudent(null)" class="mb-4 flex items-center text-sm text-slate-500 hover:text-slate-900 transition-colors">
                        <i data-lucide="arrow-right" class="w-4 h-4 ml-1"></i>
                        عودة للقائمة
                    </button>

                    <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm mb-6 text-center">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <span class="text-2xl font-bold text-slate-700">${student.name.charAt(0)}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-900 mb-1">${student.name}</h2>
                        <p class="text-slate-500">${student.surah} • ${student.age} سنة</p>
                    </div>

                    <div class="space-y-3">
                        ${student.dailyScores.map((day, index) => renderDayRow(student, index)).join('')}
                    </div>
                </div>
            `;
    }

    function renderDailyView(students) {
        const dayIndex = state.selectedDay - 1;

        return `
                <div class="animate-fade-in">
                    <!-- Day Navigation -->
                    <div class="bg-white p-2 rounded-xl border border-slate-100 shadow-sm mb-6 flex items-center justify-between sticky top-[180px] z-10">
                        <button onclick="changeDay(-1)" class="p-2 hover:bg-slate-50 rounded-lg text-slate-500">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                        <div class="text-center">
                            <div class="text-sm font-medium text-slate-900">اليوم ${state.selectedDay}</div>
                            <div class="text-xs text-slate-500">ربيع أول</div>
                        </div>
                        <button onclick="changeDay(1)" class="p-2 hover:bg-slate-50 rounded-lg text-slate-500">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        ${students.map(student => `
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="font-bold text-slate-900">${student.name}</h3>
                                    <span class="text-xs bg-slate-100 px-2 py-1 rounded-md text-slate-600">${student.surah}</span>
                                </div>
                                ${renderInputControls(student, dayIndex)}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
    }

    function renderDayRow(student, dayIndex) {
        const day = student.dailyScores[dayIndex];
        const isToday = dayIndex + 1 === state.selectedDay;

        return `
                <div class="bg-white p-4 rounded-xl border ${isToday ? 'border-emerald-200 ring-1 ring-emerald-100' : 'border-slate-100'} shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-bold text-slate-700">اليوم ${dayIndex + 1}</span>
                        ${isToday ? '<span class="text-xs bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full">اليوم</span>' : ''}
                    </div>
                    ${renderInputControls(student, dayIndex)}
                </div>
            `;
    }

    function renderInputControls(student, dayIndex) {
        const day = student.dailyScores[dayIndex];
        const hasScore = day.memorization > 0 || day.review > 0;
        const isAttendedOnly = day.attended && !hasScore;

        if (isAttendedOnly) {
            return `
                    <div class="flex items-center justify-between bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                        <div class="flex items-center gap-2 text-emerald-700 font-medium">
                            <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                            <span>حاضر فقط</span>
                        </div>
                        <button onclick="toggleAttendance('${student.id}', ${dayIndex})" class="text-sm text-emerald-600 hover:text-emerald-800 underline">
                            تغيير
                        </button>
                    </div>
                `;
        }

        return `
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-emerald-600 mb-1.5">حفظ</label>
                        <input
                            type="number"
                            inputmode="decimal"
                            step="0.5"
                            min="0"
                            max="20"
                            value="${day.memorization || ''}"
                            placeholder="0"
                            onchange="updateScore('${student.id}', ${dayIndex}, 'memorization', this.value)"
                            class="w-full h-10 px-3 rounded-lg border border-slate-200 bg-slate-50 text-center font-bold text-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                        >
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-blue-600 mb-1.5">مراجعة</label>
                        <input
                            type="number"
                            inputmode="decimal"
                            step="0.5"
                            min="0"
                            max="20"
                            value="${day.review || ''}"
                            placeholder="0"
                            onchange="updateScore('${student.id}', ${dayIndex}, 'review', this.value)"
                            class="w-full h-10 px-3 rounded-lg border border-slate-200 bg-slate-50 text-center font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                        >
                    </div>
                    <button
                        onclick="toggleAttendance('${student.id}', ${dayIndex})"
                        class="h-10 px-3 rounded-lg border border-slate-200 bg-white text-slate-400 hover:bg-slate-50 hover:text-slate-600 transition-colors"
                        title="حضور فقط"
                    >
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
    }

    // --- Actions ---
    function setViewMode(mode) {
        state.viewMode = mode;
        render();
    }

    function selectStudent(id) {
        state.selectedStudentId = id;
        render();
    }

    function setFilter(teacher) {
        state.filterTeacher = teacher;
        render();
    }

    function changeDay(delta) {
        const newDay = state.selectedDay + delta;
        if (newDay >= 1 && newDay <= 30) {
            state.selectedDay = newDay;
            render();
        }
    }

    function goToToday() {
        const today = getHijriDate().day;
        state.selectedDay = today;
        if (state.viewMode === 'daily') {
            render();
        }
    }

    function updateOfflineIndicator() {
        const indicator = document.getElementById('offline-indicator');
        if (indicator) {
            indicator.className = `w-3 h-3 rounded-full ${state.isOnline ? 'bg-emerald-500' : 'bg-amber-500'} transition-colors`;
        }
    }

    // --- Initialization ---
    window.addEventListener('online', () => { state.isOnline = true; updateOfflineIndicator(); });
    window.addEventListener('offline', () => { state.isOnline = false; updateOfflineIndicator(); });

    initData();
</script>
</body>
</html>
